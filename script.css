// Ambil elemen display
const display = document.getElementById('display');
// State kalkulator
let currentInput = '0';
let firstOperand = null;
let operator = null;
let waitingForSecondOperand = false;

// Fungsi untuk memperbarui tampilan
function updateDisplay() {
    display.value = currentInput;
}

// Fungsi untuk menangani input angka
function inputDigit(digit) {
    if (waitingForSecondOperand === true) {
        currentInput = digit;
        waitingForSecondOperand = false;
    } else {
        currentInput = currentInput === '0' ? digit : currentInput + digit;
    }
    updateDisplay();
}

// Fungsi untuk menangani titik desimal
function inputDecimal(dot) {
    if (waitingForSecondOperand === true) {
        currentInput = '0.';
        waitingForSecondOperand = false;
        return;
    }
    if (!currentInput.includes(dot)) {
        currentInput += dot;
    }
    updateDisplay();
}

// Fungsi untuk mereset kalkulator
function clearAll() {
    currentInput = '0';
    firstOperand = null;
    operator = null;
    waitingForSecondOperand = false;
    updateDisplay();
}

// Fungsi untuk menjalankan operasi aritmetika
function performCalculation(op, num1, num2) {
    switch (op) {
        case '+': return num1 + num2;
        case '-': return num1 - num2;
        case '*': return num1 * num2;
        case '/': 
            if (num2 === 0) {
                alert("Error! Pembagian dengan nol tidak diizinkan.");
                return 'Error';
            }
            return num1 / num2;
        default: return num2;
    }
}

// Fungsi untuk menangani operator dasar
function handleOperator(nextOperator) {
    const inputValue = parseFloat(currentInput);

    if (operator && waitingForSecondOperand) {
        operator = nextOperator;
        return;
    }

    if (firstOperand === null) {
        firstOperand = inputValue;
    } else if (operator) {
        const result = performCalculation(operator, firstOperand, inputValue);
        
        if (result === 'Error') {
            clearAll();
            updateDisplay();
            return;
        }

        currentInput = String(result);
        firstOperand = result;
    }

    waitingForSecondOperand = true;
    operator = nextOperator;
    updateDisplay();
}

// --- Fungsi Ilmiah ---

// Akar Kuadrat (sqrt)
function squareRoot() {
    const num = parseFloat(currentInput);
    if (num < 0) {
        alert("Error! Input akar kuadrat tidak boleh negatif.");
        clearAll();
        return;
    }
    currentInput = String(Math.sqrt(num));
    updateDisplay();
    waitingForSecondOperand = true;
}

// Pangkat (pow) - Menunggu dua input. Untuk sementara, gunakan currentInput sebagai basis.
function powerBase() {
    firstOperand = parseFloat(currentInput);
    operator = 'pow';
    waitingForSecondOperand = true;
    currentInput = '0';
    updateDisplay();
}

// Logaritma (log) - Menunggu dua input. Untuk sementara, gunakan currentInput sebagai angka.
function logarithmNumber() {
    firstOperand = parseFloat(currentInput);
    operator = 'log';
    waitingForSecondOperand = true;
    currentInput = '0';
    updateDisplay();
}

// Fungsi Trigonometri (membutuhkan input dalam radian)
function trigonometricFunc(func) {
    const num = parseFloat(currentInput);
    let result = 0;
    
    switch (func) {
        case 'sin':
            result = Math.sin(num);
            break;
        case 'cos':
            result = Math.cos(num);
            break;
        case 'tan':
            // Cek mendekati pi/2 + n*pi (tangent undefined)
            // Ini adalah pendekatan, tidak sempurna karena float precision
            const cosVal = Math.cos(num);
            if (Math.abs(cosVal) < 1e-10) { 
                alert("Error! Tangen tidak terdefinisi.");
                clearAll();
                return;
            }
            result = Math.tan(num);
            break;
    }
    currentInput = String(result);
    updateDisplay();
    waitingForSecondOperand = true;
}

// Fungsi Equals (menghitung hasil akhir atau operasi ilmiah ganda)
function handleEquals() {
    const inputValue = parseFloat(currentInput);

    if (firstOperand === null || operator === null) {
        return; // Tidak ada operasi yang tertunda
    }

    let result = null;

    if (operator === 'pow') {
        result = Math.pow(firstOperand, inputValue);
    } else if (operator === 'log') {
        if (firstOperand <= 0 || inputValue <= 0 || inputValue === 1) {
            alert("Error! Input dan basis logaritma harus positif, dan basis tidak boleh 1.");
            clearAll();
            return;
        }
        // Math.log adalah logaritma natural (ln). Kita pakai Math.log(x) / Math.log(base)
        result = Math.log(firstOperand) / Math.log(inputValue); 
    } else {
        // Operasi aritmetika biasa
        result = performCalculation(operator, firstOperand, inputValue);
        if (result === 'Error') {
             // Error sudah ditangani di performCalculation, jadi kita hanya reset state
            firstOperand = null;
            operator = null;
            waitingForSecondOperand = false;
            return;
        }
    }

    currentInput = String(result);
    firstOperand = null;
    operator = null;
    waitingForSecondOperand = true; // Siap untuk memulai operasi baru
    updateDisplay();
}

// --- Event Listeners ---

const buttons = document.querySelector('.button-grid');
buttons.addEventListener('click', (event) => {
    const { target } = event;
    if (!target.matches('button')) {
        return;
    }

    if (target.classList.contains('number')) {
        inputDigit(target.dataset.num);
        return;
    }

    if (target.dataset.num === '.') {
        inputDecimal('.');
        return;
    }

    if (target.classList.contains('clear')) {
        clearAll();
        return;
    }

    if (target.classList.contains('operator')) {
        handleOperator(target.dataset.op);
        return;
    }
    
    // Fungsi Ilmiah Satu Input
    if (target.dataset.func === 'sqrt') {
        squareRoot();
        return;
    }
    if (['sin', 'cos', 'tan'].includes(target.dataset.func)) {
        trigonometricFunc(target.dataset.func);
        return;
    }

    // Fungsi Ilmiah Dua Input (membutuhkan '=' untuk menghitung)
    if (target.dataset.func === 'pow') {
        powerBase();
        return;
    }
    if (target.dataset.func === 'log') {
        logarithmNumber();
        return;
    }
    
    // Tombol Sama Dengan
    if (target.dataset.func === 'equals') {
        handleEquals();
        return;
    }
});

// Inisialisasi tampilan saat halaman dimuat
updateDisplay();
